pi=3.1415926; 
  

data=[           
3795	8.79944E-05
3790	8.59041E-05
3785	6.10626E-05
3780	8.48825E-05
3775	8.12087E-05
3770	0.000116748
3765	0.000104098
3760	7.36817E-05
3755	8.81629E-05
3750	7.62612E-05
3745	6.45753E-05
3740	8.43243E-05
3735	8.28406E-05
3730	9.29099E-05
3725	0.00010782
3720	0.000121685
3715	0.000130853
3710	0.000114905
3705	0.000131099
3700	0.000134408
3695	0.000133488
3690	0.000132508
3685	0.00016816
3680	0.000140209
3675	8.13189E-05
3670	0.000105901
3665	0.000144106
3660	0.00013539
3655	0.000125588
3650	8.74155E-05
3645	0.00019301
3640	0.00021082
3635	0.000212796
3630	0.000172808
3625	0.000242463
3620	0.000249953
3615	0.000251953
3610	0.000299792
3605	0.000285106
3600	0.000324757
3595	0.000331498
3590	0.000332479
3585	0.000395148
3580	0.000363609
3575	0.000407057
3570	0.000409678
3565	0.000428881
3560	0.00047954
3555	0.000472772
3550	0.000451526
3545	0.000479824
3540	0.000559384
3535	0.000565251
3530	0.000541491
3525	0.000628955
3520	0.000489166
3515	0.000627191
3510	0.000596978
3505	0.000631963
3500	0.000613807
3495	0.000655944
3490	0.000714465
3485	0.000634263
3480	0.000700451
3475	0.000708662
3470	0.000740641
3465	0.00070289
3460	0.000698228
3455	0.000747213
3450	0.000783153
3445	0.000690792
3440	0.000764856
3435	0.000708057
3430	0.000663249
3425	0.000624656
3420	0.000661786
3415	0.000651775
3410	0.000605935
3405	0.00065886
3400	0.000597023
3395	0.000640807
3390	0.000532112
3385	0.000560958
3380	0.000592774
3375	0.000579232
3370	0.000530837
3365	0.000555485
3360	0.000520702
3355	0.000541158
3350	0.000548484
3345	0.000592128
3340	0.000643255
3335	0.000621299
3330	0.000589009
3325	0.00062714
3320	0.000705076
3315	0.000567961
3310	0.000648838
3305	0.000631425
3300	0.000661371
3295	0.000701101
3290	0.000668024
3285	0.000703588
3280	0.000693664
3275	0.000740673
3270	0.000771458
3265	0.000748108
3260	0.000778772
3255	0.000719012
3250	0.000752148
3245	0.00072132
3240	0.000775867
3235	0.000820241
3230	0.000664719
3225	0.000714425
3220	0.000690481
3215	0.000666915
3210	0.000584859
3205	0.000553178
3200	0.000557972
3195	0.00053289
3190	0.000512569
3185	0.000536827
3180	0.000517016
3175	0.00051046
3170	0.000500792
3165	0.000475762
3160	0.000403684
3155	0.000395663
3150	0.000455089
3145	0.000429313
3140	0.000447504
3135	0.000391807
3130	0.000356639
3125	0.0003512
3120	0.000364867
3115	0.000373339
3110	0.000310701
3105	0.000278112
3100	0.000256356
3095	0.00028024
3090	0.000258101
3085	0.000264928
3080	0.000283826
3075	0.000230106
3070	0.000232132
3065	0.000232136
3060	0.000242197
3055	0.000207891
3050	0.000219314
3045	0.000183259
3040	0.000198972
3035	0.000202273
3030	0.000198976
3025	0.000223081
3020	0.000218628
3015	0.000222423
3010	0.000187579
3005	0.000182306
3000	0.000151333
2998	0.000182107
2995	0.000152633
2992	0.000155988
2989	0.000146423
2986	0.000135117
2983	0.000133788
2980	0.00015928
2977	0.000167788
2974	0.000272867
2971	0.000613103
2968	0.001034635
2965	0.001526373
2962	0.002106248
2959	0.002613782
2956	0.002996279
2953	0.003297158
2950	0.004199121
2947	0.004851414
2944	0.005564388
2941	0.005323687
2938	0.003223955
2935	0.00221567
2932	0.001001632
2929	0.000393773
2926	0.000122416
2923	8.5267E-05
2920	0.000144485
2917	0.000276284
2914	0.000422955
2911	0.000572796
2908	0.000726356
2905	0.000915216
2902	0.000961789
2899	0.001044608
2896	0.00127716
2893	0.001386357
2890	0.001703755
2887	0.002197552
2884	0.00285233
2881	0.005867886
2878	0.007774204
2875	0.007149085
2872	0.004361072
2869	0.002222017
2866	0.002048861
2863	0.001757977
2860	0.001350971
2857	0.001037435
2854	0.000767694
2851	0.000588951
2848	0.000404439
2845	0.000416151
2842	0.000381017
2839	0.00031583
2836	0.00028423
2833	0.000226009
2830	0.000198269
2827	0.000163907
2824	0.000141374
2821	0.000103511
2818	9.30217E-05
2815	7.55437E-05
2812	6.71323E-05
2809	5.28024E-05
2806	5.6099E-05
2803	5.02282E-05
2800	4.32853E-05
];
 
 
x=data(:,1);
y=data(:,2);
 
 
% read parameter
 
% num of peaks
 
% for each peak, need parameters of 
% A:Oscillator Strength
% wr: resonent frequency;
% Tau: width
% phi: phase angle
% sigma: distribution of phase angle
 
%y=SFG_signal_sum (x,p);
 
 
p=[0
0.1
0
2850.6
14.3
0
-0.4
2878.1
4.9
0
-0.5
2892.6
19.1
0
-0.5
2939.8
7.3
0
0
2947.1
0.2
0
0.3
2964.5
10
0
2.2
3233.7
100
0
2.2
3426.2
127.1
0
-1
3591.2
98
0
 
];
 
num_peaks = (length(p)-2)/4; % num of peaks
n=50; %set optimization cycles
       
Boundary=[
0   1                           % green light level
-0.2 0.2                     % non-resonant background
-1 1
2845 2860
0 20
0 1e-15
-1 2
2875 2885
0 10
0 1e-15
-1 1
2890 2910
0 20
0 1e-15
1 2
2930 2940
0 20
0 1e-15
-1 2
2940 2950
0 10
0 1e-15
0 1
2955 2970
0 20
0 1e-15
0 15
3100 3300
50 200
0 1e-15
0 8
3380 3600
50 200
0 1e-15
-1 5
3550 3700
50 200
0 1e-15 

  

]; 

  

p_LB= Boundary(:,1); 

p_UB= Boundary(:,2); 

  

  

%[p_LB,p_UB]=Xin_Set_Parameter_Boundary(p); 

  

pall=zeros(length(p),3); 

pall(:,1)=p_LB; 

pall(:,2)=p; 

pall(:,3)=p_UB; 

  

%boundary=[50]; 

  

%p_LB=p-boundary; 

%p_UB=p+boundary; 

  

  

%Display the initial error 

%y_predicted = SFG_signal_sum(p, x); 

%[relative_residual,residual]=relative_residual(y_predicted,y); 

%disp(strcat('Initial error = ',num2str(relative_residual))); 

% optimization  

options=optimset('Maxiter',500000,'TolFun',1.0*10^-9); %set iterative cycles 

for index=1:n 

   disp(strcat('********Starting optimization cycle # ',num2str(index),'********')); 

   [p,residual_norm,residual]=lsqcurvefit('SFG_signal_sum',p,x,y,p_LB,p_UB,options); 

   relative_residual = sqrt(residual_norm / sum (y.^2)); 

    disp(strcat('relative error = ',num2str(relative_residual))); 

  

end 

  

  

% print final error for individual points and sum_error 

if n>=0 

    peaks=zeros(length(y),10); 

   for index =1:num_peaks 

      temp=SFG_Lorentzian_Gaussian(p(index*4-1),p(index*4),x,p(index*4+1),p(index*4+2)); 

      peaks(:,index)=abs(temp).^2; 

   end 

    

   y_predicted = SFG_signal_sum(p, x);    

   figure; 

   plot(x,y,'ro',x,y_predicted,'b-',x,peaks(:,1),'r--',x,peaks(:,2),'g--',x,peaks(:,3),'c--',x,peaks(:,4),'r--',x,peaks(:,5),'g--',x,peaks(:,6),'g--',x,peaks(:,7),'g--',x,peaks(:,8),'g--',x,peaks(:,9),'g--');  % plot y against x 

  

    % Print final variables 

    disp(p); 

end 

  

% Print results 

  

ys=zeros(10,length(y));  

ys(1,:)=rot90(x); 

ys(2,:)=rot90(y); 

ys(3,:)=rot90(y_predicted); 

  

  

for index =1:num_peaks 

      temp=SFG_Lorentzian_Gaussian(p(index*4-1),p(index*4),x,p(index*4+1),p(index*4+2)); 

      ys(index+3,:)=rot90(abs(temp).^2); 

end 

    

fid=fopen('100% LPA+ 2mM Nacl uM CaCl2.txt','w'); 

fprintf(fid,'%6.6f  %6.6f   %6.6f   %6.6f   %6.6f   %6.6f   %6.6f   %6.6f  %6.6f  %6.6f   %6.6f     %6.6f\n',ys); %equal to number of peaks plus 3 

fclose(fid); 
